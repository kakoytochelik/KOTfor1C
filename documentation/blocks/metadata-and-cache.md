# Блок: Metadata and Cache

## Задача блока

Обеспечить стабильную структуру метаданных сценариев и быстрое обновление состояния проекта без тяжелых полных пересканирований на каждое действие.

## `KOTМетаданные`

### Для чего нужен блок

- Хранит служебные данные сценария.
- Используется Test Manager (`Менеджер тестов`) для группировки и отображения.
- Хранит пользовательское описание сценария (`Описание`).

### Что делает расширение автоматически

- Поддерживает чтение legacy-тегов и нового формата.
- Мигрирует legacy-данные в `KOTМетаданные` при сохранении.
- Восстанавливает структуру блока, если она случайно повреждена.
- Сохраняет пользовательское содержимое описания при автооперациях.

## Кеш сценариев

### Что в кеше

- Имя, UID, код сценария.
- Информация о вложенных вызовах.
- Параметры сценария и дефолты.
- Метаданные для Test Manager (`Менеджер тестов`).

### Как кеш обновляется

- Полный refresh при необходимости.
- Инкрементальные обновления после изменений сценариев.
- Пометка stale для run-артефактов при изменениях в связанных файлах.
- Сохранения неактивных сценариев попадают в очередь и могут быть обработаны пакетной командой `Scenario repair`.

## Зависимости и влияние изменений

- Изменение вложенного сценария может влиять на главные сценарии выше по цепочке вызовов.
- Test Manager (`Менеджер тестов`) подсвечивает затронутые главные сценарии (если включено в настройках).
- Run-статус может переходить в `stale`, чтобы не вводить в заблуждение старыми «зелеными» результатами.

## Настройки блока

| Настройка | Назначение |
|---|---|
| `kotTestToolkit.phaseSwitcher.highlightAffectedMainScenarios` | Подсветка затронутых главных сценариев |
| `kotTestToolkit.editor.autoEnsureKotMetadataForMainScenarios` | Автодобавление/восстановление `KOTМетаданные` для всех типов сценариев |
| `kotTestToolkit.editor.enableLegacyMetadataMigrationForMainScenarios` | Опциональная миграция legacy-тегов `# PhaseSwitcher_*` в `KOTМетаданные` только для главных сценариев (под-настройка автообеспечения `KOTМетаданные`) |
| `kotTestToolkit.editor.checkRelatedParentScenarios` | Проверка ошибок связанных родительских сценариев |
| `kotTestToolkit.paths.yamlSourceDirectory` | Область сканирования сценариев |

## Практические советы

- Держите `yamlSourceDirectory` максимально точным (лишние папки = лишняя нагрузка).
- Для больших проектов используйте глобальный scan только при крайней необходимости.
- После крупных массовых правок делайте сборку заново, чтобы сбросить stale-статусы.
- После массовых правок (Replace in Files) используйте `Repair changed scenarios` для безопасной проверки и исправления структуры сценариев.
