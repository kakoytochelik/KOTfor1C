# Change Log

# 2.0.0

- **Breaking changes**:
    - Ребрендинг: новое имя расширения `KOT for 1C`.
    - Новый Marketplace ID: `AlexeyEremeev.kot-test-toolkit`.
    - Команды и настройки переведены на префикс `kotTestToolkit.*` и в контекстном меню имеют префикс `КОТ -`.
    - Удалены устаревшие 1C:Drive-специфичные функции:
        - настройки тестовой почты;
        - поддержка `RepairTestFile`.

- **Ключевые возможности**:
    - **Запуск Vanessa Automation из Phase Switcher:**
        - Добавлен запуск сценариев в Vanessa Automation напрямую из панели расширения.
        - Поддержаны режимы обычного прогона и ручной отладки.
        - Для сценариев отображаются состояния запуска (`running/passed/failed`) и признак `stale` для устаревших артефактов.
    - **Улучшения сборки сценариев и менеджера параметров:**
        - Добавлена кнопка отмены сборки сценариев с остановкой запущенных процессов.
        - Интерфейс Менеджера Параметров Сборки сценариев разделен на 3 вкладки:
            - параметры сборки СППР;
            - дополнительные параметры Vanessa Automation;
            - глобальные переменные `GlobalVars` для Vanessa Automation.
        - Добавлены импорт/экспорт JSON для всех секций.
    - **Новая диагностика сценариев и quick fix:**
        - Добавлены проверки неизвестных шагов и вызовов, параметров вызовов, кавычек, `If/Do` блоков, неполных секций и дублей кода сценария.
        - Добавлены быстрые исправления, включая `Maybe you meant` и автодобавление недостающих параметров.
    - **Добавлены `KOTМетаданные`:**
        - Добавлена поддержка `KOTМетаданные.PhaseSwitcher` как основного источника метаданных для Phase Switcher.
        - Автомиграция legacy-тегов `# PhaseSwitcher_*` при сохранении файла.
        - Поддержка описания сценария в `KOTМетаданные.Описание`.
    - **Улучшены hover-подсказки и автодополнение:**
        - по шагам — теперь с подстановкой фактических аргументов из строки;
        - по вызовам вложенных сценариев — с описанием сценария и краткой сводкой.
    - **Улучшения редактора сценариев:**
        - Добавлено авто-выравнивание Gherkin-таблиц и параметров вызова вложенных сценариев.
        - Улучшена логика автозаполнения `ВложенныеСценарии` и `ПараметрыСценария` (обновление только при реальных изменениях).
        - Добавлены исключения параметров сценария (`editor.scenarioParameterExclusions`).
        - Улучшено сохранение пользовательских атрибутов параметров при перезаполнении секций.

- **Мелкие улучшения и исправления**:
    - Улучшено автодополнение вызовов вложенных сценариев с учетом значений по умолчанию параметров.
    - Добавлены настройки:
        - `output.advancedLogging`
        - `assembleScript.showDriveFeatures`
        - `editor.checkRelatedParentScenarios`

- **Производительность и стабильность**:
    - Улучшено кеширование сценариев: инкрементальные обновления и меньше полных пересканирований.
    - Добавлена команда ручного полного сканирования workspace-диагностики (для контроля нагрузки на больших проектах).

- **Документация и упаковка**:
    - Обновлены README и документация по настройке/разработке.
    - Обновлены локализации интерфейса.
    - Проведена чистка пакета расширения (VSIX).

# 1.11.2
- **Новые возможности**:
    - **Менеджер параметров Сборки Сценариев:**
        - Новый интерфейс для управления параметрами `yaml_parameters.json` через удобную таблицу ключ-значение.
        - Параметры по умолчанию генерируются на основе настроек расширения (BuildPath, yamlSourceDirectory).
        - Безопасное хранение настроек в VS Code SecretStorage.
        - Поддержка загрузки/сохранения параметров из/в JSON файлы.
        - Список поддерживаемых параметров доступен [на ИТС](https://its.1c.ru/db/sppr2doc#content:124:hdoc:issogl1_11.8.3).
- **Исправления**:
    - **Исправлена недоступность кнопки обновления:** Кнопка "Обновить" теперь всегда доступна, даже когда не найдено ни одного теста для Phase Switcher.
    - **Исправлены жестко заданные пути:** Заменена жестко заданная константа `SCAN_DIR_RELATIVE_PATH` на использование настройки `YamlSourceDirectory`.
    - Исправлены непереведенные сообщения и тултипы.
    - Исправлено добавление лишней строки в блок ВложенныеСценарии.
    - Табуляции теперь заменяются только в начале строки.
    - Сборка файла FirstLaunch теперь обрабатывает только нужные xml файлы.
    - Создание новых главных сценариев теперь учитывает настройку ModelBDid (указывается в Менеджер параметров Сборки Сценариев).
    - Автозамена табов и перезаполнение блоков в шапке сценариев, а также предложения автодополнения шагов, теперь работают только в YAML файлах, имеющих строку `ТипФайла: "Сценарий"` (это защита yaml файлов, не относящихся к тестам).
- **Удалено**:
    - **Настройка YAML Parameters Template:** Удалена в пользу нового Менеджера параметров Сборки Сценариев.
    - **Настройка Split Feature Files:** Удалена, так как задается через Менеджер параметров Сборки Сценариев.
    - **Настройка параметров СборкаТекстовСценариев:** Удалена, так как все параметры теперь управляются через Менеджер параметров Сборки Сценариев.

# 1.10.6
- Исправлено запоминание значений параметров, когда значение - пустая строка.

# 1.10.5
- **Новые возможности**:
    - **Автозаполнение при сохранении:**
        - Добавлена возможность автоматического заполнения секций ВложенныеСценарии и ПараметрыСценария при сохранении YAML файлов.
        - Новая логика "очистить и заполнить заново" обеспечивает правильный порядок элементов согласно тексту сценария.
        - Сохранение пользовательских значений параметров (поле `Значение: "Value"`) при автозаполнении.
        - Отдельные настройки для каждой функции: замена табов, заполнение вложенных сценариев, заполнение параметров.
        - Единый прогресс-бар и консолидированные уведомления о выполненных операциях.
        - Автоматическое сохранение файла после обработки для предотвращения отображения несохраненных изменений.
    - **Оптимизация производительности:**
        - **Инициализация кеша при запуске:** Сканирование рабочей области и построение кеша сценариев происходит сразу при активации расширения, а не при первом открытии панели.
        - **Кеширование UID сценариев:** Добавлено извлечение и кеширование UID из блоков ДанныеСценария для быстрого доступа.
        - **Оптимизированное заполнение вложенных сценариев:** Использование кеша вместо поиска по файловой системе ускоряет операцию в 25-50 раз.
        - **Оптимизированное открытие сценариев:** Мгновенное открытие сценариев через кеш вместо медленного поиска по файлам (ускорение в 50-100 раз).
- **Исправления**:
    - **Унифицированная логика:** Ручные команды и автосохранение используют одинаковую логику "очистить и заполнить".
    - **Улучшенная обработка параметров:** Корректное определение параметров сценария (только символы `_`, `-`, буквы и цифры).

# 1.9.9
- **Новые возможности**:
    - **Настраиваемые параметры запуска 1С:**
        - Добавлена возможность настройки всех параметров запуска 1С:Предприятие через единую строку настроек.
        - Отдельная настройка для дополнительных параметров `/C` для обработки СборкаТекстовСценариев. Подробнее о параметрах [здесь](https://its.1c.ru/db/sppr2doc#content:124:hdoc).
    - **Настраиваемые пути проекта:**
        - Все ранее жестко заданные пути теперь можно настроить через параметры расширения.
        - Настройка пути к папке FirstLaunch с автоматическим скрытием кнопки, если папка не существует.
    - **Улучшенная обратная связь при сборке:**
        - Улучшенные уведомления о результатах сборки.
        - Улучшенное отображение Output лога.
        - Кнопка "Открыть файл ошибок" для быстрого доступа к JUnit XML файлу с подробностями.
        - Точное определение наличия ошибок через анализ содержимого JUnit XML файла.
- **Исправления и улучшения**:
    - **Оптимизированы файлы локализации:** Удалены неиспользуемые строки переводов.
    - **Исправлена нумерация настроек:** Все настройки теперь имеют последовательные номера порядка для корректного отображения.
    - **Удалена устаревшая функциональность:** Полностью убрана обработка DriveTrade.

# 1.9.1
- **Новые возможности**:
    - **Мультиязычность:**
        - Полная локализация интерфейса расширения на русский и английский языки.
        - Настройка `Language override` для выбора языка расширения независимо от языка VS Code.
        - Мультиязычные шаги Gherkin с поддержкой 4-колоночной структуры в `steps.htm` (русский шаг, русское описание, английский шаг, английское описание).
        - Умное отображение: при вводе русского шага показывается русское описание и оба варианта шага, при вводе английского - английское описание и так же оба варианта.
    - **Автоматическая конвертация табов:**
        - При сохранении YAML файлов табуляции автоматически заменяются на пробелы.
        - Удалена ручная команда "Заменить табы на пробелы" из контекстного меню.
- **Исправления и доработки:**
    - Улучшен парсинг многострочных шагов из `steps.htm`.
    - Улучшена обработка ошибок с локализованными сообщениями.
    - Все операции поиска файлов, заполнения параметров и обновления шагов теперь показывают прогресс выполнения.

# 1.8.0
- **Новые возможности**:
    - **Автоматическое создание архива FirstLaunch:**
        - В палитре команд и в панели `Сборка` добавлена кнопка создания архива FirstLaunch `Собрать FL`.
        - Автоматически устанавливается версия конфигурации из текущей ветки во всех местах, где это требуется.
        - Возможность сохранить итоговый архив в пользовательскую директорию и открыть эту директорию.
- **Исправления и доработки:**
    - Панель `Сборка тестов` переименована в просто `Сборка`, так как теперь собираются не только тесты, но и архив FirstLaunch.
    - Список `Accounting` переименован в `Accounting mode`.
    - Убран переключатель DriveTrade, так как это легаси механика.
    - Параметр `Split Feature Files` теперь по умолчанию выключен.

# 1.7.1
- **Исправления и доработки:**
    - **Реорганизация настроек:**
        - Более точное расположение настроек по категориям.
        - Убраны неиспользуемые настройки (`DbUser`, `DbPassword`).
        - Вместо выпадающего списка `Split Feature Files` теперь является чекбоксом. Значение по умолчанию `True`. Добавлено более точное описание настройки.
    - **Проверка заполненности параметров:**
        - При попытке запустить сборку тестов без установленных в настройках путей будет понятная ошибка и предложение заполнить настройки.
        - При попытке открыть файл MXL без установленных в настройках путей будет понятная ошибка и предложение заполнить настройки.

# 1.7.0
- **Новые возможности**:
    - **Работа с файлами из редактора:**
        - **Открыть MXL файл в редакторе:** Добавлена команда в контекстное меню для поиска и открытия `.mxl` файла по выделенному имени в программе "1С:Предприятие — работа с файлами" (требуется установить отдельно).
        - **Показать файл в проводнике VS Code:** Новая команда для поиска файла по выделенному имени и его отображения в боковой панели VS Code.
        - **Открыть в системном проводнике:** Новая команда для открытия расположения найденного файла в Windows Explorer или Finder.
    - **Улучшения процесса сборки:**
        - **Прогресс-бар:** Во время сборки тестов теперь отображается уведомление с прогресс-баром.
        - **Уведомления об ошибках:** В случае неудачной сборки появляется уведомление с кнопкой для быстрого перехода к файлу лога.
        - **Опциональный Output:** Добавлена настройка для включения/отключения автоматического открытия панели Output при запуске сборки.
        - **Открытие результатов сборки**: После успешной сборки тестов можно открыть директорию с собранными `.feature` файлами.
    - **Создание сценариев:**
        - При создании главного или вложенного сценария теперь автоматически создается пустая папка files для сопутствующих файлов (унификация).

# 1.6.2
- **Новые возможности**:
    - Так как секции `ВложенныеСценарии` и `ПараметрыСценария` могут содержать множество блоков, для повышения удобства навигации и читабельности добавлена функция автоматического сворачивания этих секций при открытии файла теста. Переключается в настройках.

# 1.6.1
- **Исправления и доработки:**
    - Добавлена автонумерация автозаполняемых блоков в секциях `ВложенныеСценарии` и `ПараметрыСценария`.
    - Улучшена логика отступов и переносов строк для автозаполняемых блоков в секциях `ВложенныеСценарии` и `ПараметрыСценария`.
    - Исправлен и ускорен парсинг сценариев с спецсимволами для автозаполнения блоков в секциях `ВложенныеСценарии` и `ПараметрыСценария`.

## 1.6.0
- **Автозаполнение секции "ВложенныеСценарии":**
    - По команде контектного меню `1C:Drive - Заполнить секцию ВложенныеСценарии` секция автоматически заполняется недостающими блоками вызываемых сценариев.
- **Автозаполнение секции "ПараметрыСценария":**
    - По команде контектного меню `1C:Drive - Заполнить секцию ПараметрыСценария` секция автоматически заполняется недостающими блоками используемых в сценарии параметров.
- **Замена табов на пробелы:**
    - По команде контектного меню `1C:Drive - Заменить табы на пробелы` все отступы табуляциями заменяются на 4 пробела.
- **Убраны старые команды из контекстного меню:** (_они все еще доступны из палитры_)
    - `1C:Drive - Вставить блок ВложенныеСценарии`
    - `1C:Drive - Вставить блок ПараметрыСценария`

## 1.5.2
- **Улучшенная вставка блока "ВложенныеСценарии":**
    - Автозаполнение из выделения: Если при вызове команды выделена строка, соответствующая вызову сценария, расширение теперь попытается найти файл этого сценария.
    - В случае успеха, поля `UIDВложенныйСценарий` и `ИмяСценария` во вставляемом блоке будут автоматически заполнены значениями `UID` и `Имя` из найденного файла сценария.
    - Если файл сценария не найден, или из него не удалось извлечь UID/Имя, блок будет вставлен с пустыми значениями, как и раньше.
- **Секции контекстного меню**:
    - Пункты контекстного меню разделены на 3 категории:
        - Навигация
        - Создание
        - Редактирование

## 1.5.0
- **Автодополнение для вызовов вложенных сценариев:**
    - При вводе текста в блоке `ТекстСценария:` предлагаются варианты автодополнения не только для стандартных шагов Gherkin, **но и для вызовов всех найденных сценариев**.
    - Если выбранный для вставки сценарий содержит параметры, он вставляется как многострочный сниппет, включающий имя сценария и строки для каждого параметра с плейсхолдерами для их значений. 
    - Список сценариев и их параметров для автодополнения обновляется при нажатии кнопки "Обновить" на панели "KOT for 1C" (вместе с обновлением данных для Phase Switcher).

- **Внешняя загрузка определений шагов Gherkin:**
    - Добавлена возможность загружать файл `steps.htm` (используемый для автодополнения и подсказок) с внешнего URL-адреса. Это позволяет обновлять определения шагов без необходимости обновления всего расширения.
    - В настройки расширения пользователь может указать URL для файла `steps.htm` (по умолчанию установлена ссылка на файл в репозитории). Если оставить пустым, будет использоваться только локальная копия из расширения.
    - Реализован механизм кеширования: загруженный файл сохраняется локально и используется в течение 24 часов или до следующего изменения URL.
    - Добавлена новая команда в палитру команд: `1C:Drive - Обновить библиотеку шагов`. Эта команда принудительно загружает `steps.htm` с указанного URL и обновляет кеш.
    - В случае недоступности внешнего ресурса или ошибки загрузки, расширение будет использовать данные из кеша (если он валиден) или, в крайнем случае, локальную копию `steps.htm`, включенную в состав расширения, для обеспечения непрерывной работы.

- **Кнопки создания сценариев:**
    - В панель Phase Switcher добавлены кнопки создания Главных или Вложенных сценариев.

- **Исправлено:**
    - При создании нового Главного сценария, список тестов в Phase Switcher теперь автоматически обновляется.



## 1.4.1
- Добавлена кнопка Свернуть/Развернуть все фазы
- Добавлена индикация непримененных изменений внутри фазы
- Обновление стилей кнопок 

## 1.4.0

- **Интеграция сборки тестов в TypeScript**:
    - Полностью перенесена логика скрипта `BuildYAML.bat` в код плагина (`phaseSwitcher.ts`).
    - Процесс сборки тестов теперь управляется непосредственно из расширения, используя API VS Code и Node.js для файловых операций и запуска процессов 1С.
    - [BETA] Сборка тестов теперь запускается на macOS.
- **Улучшения интерфейса "Phase Switcher"**:
    - Заменен выпадающий список фаз на древовидное представление (Tree-View) с раскрывающимися группами.
    - В заголовки групп фаз добавлен счетчик включенных тестов.
    - Добавлены индивидуальные кнопки-переключатели в заголовок каждой фазы для переключения тестов внутри конкретной фазы. _(Удалена общая кнопка "Переключить фазу".)_
- **Исправления**:
    - [Кнопка Обновить активна во время сборки тестов](https://github.com/kakoytochelik/KOTfor1C/issues/2)
    - [Не запускается сборка тестов, если путь до пустой базы содержит пробелы](https://github.com/kakoytochelik/KOTfor1C/issues/1)

## 1.3.3

- Интегрирована функциональность сборки тестов в панель расширения с заменой переменных в тестах
- Добавлены настройки расширения
- Добавлены иконки кнопок
- Исправлены стили и отображение некоторых элементов интерфейса

## 1.2.0

- Реализовано автодополнение шагов Gherkin на основе библиотеки шагов Vanessa Automation.
- Добавлены всплывающие подсказки для шагов Gherkin, отображающие описание шага из библиотеки шагов Vanessa Automation при наведении мыши на строку шага в YAML файлах.

## 1.1.1

- Добавлена возможность переходить к родительским сценариям из Phase Switcher
- Вставка блоков ВложенныеСценарии и ПараметрыСценария теперь происходит автоматически в соответствующие секции, а не в позицию курсора
- Улучшено отображение длинных названий сценариев в Phase Switcher

## 1.0.0

- Первый релиз
