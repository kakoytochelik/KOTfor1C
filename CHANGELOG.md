# Change Log

# 2.1.0

## Новые возможности

### Интеллектуальные подсказки шагов по запросу своими словами:

- Добавлены интеллектуальные семантические подсказки шагов в IntelliSense по префиксу `!`:
  - можно вводить формулировку желаемого шага своими словами, например: `!условие, что открылось окно`, `!проверка фоновых заданий`, и плагин предложит соответствующие шаги из библиотеки шагов Vanessa Automation;
  - для подсказок шагов установлен приоритет языка по тегу `#language:` в текущем сценарии:
    - шаги на языке сценария показываются выше;
    - шаги второго языка остаются в списке ниже.

### Навигация по вызовам вложенных сценариев

- В hover по вызову вложенного сценария добавлена ссылка `Open scenario` / `Открыть сценарий` для быстрого перехода в файл вызываемого сценария.

### Управление кодом вложенного сценария

- Добавлена команда `KOT - Изменить код вложенного сценария`:
  - за одно действие меняет `ДанныеСценария.Код` в `scen.yaml`;
  - автоматически переименовывает папку вложенного сценария под новый код.

---

# 2.0.0

## Breaking changes

- Расширение переименовано в `KOT for 1C` (_**K**eep **O**n **T**esting_).
- Панель **Phase Switcher** переименована в **Менеджер тестов** / **Test Manager**.
- Пункты контекстного меню и команды теперь имеют префикс `KOT -` ([#10](https://github.com/kakoytochelik/KOTfor1C/issues/10))
- Команды и настройки переведены на пространство имен `kotTestToolkit.*`.
- Удалены устаревшие 1C:Drive-специфичные функции: настройки тестовой почты и `RepairTestFile`.
- Новый идентификатор в Marketplace: `AlexeyEremeev.kot-test-toolkit`.

_Внимание: прошлая версия плагина (`1C:Drive Test Helper 1.11.2`) не поддерживает прямое обновление на эту версию, необходимо установить новый плагин (`KOT for 1C`), удалив старое расширение!_

## Новые возможности

### Менеджер тестов и **поддержка Vanessa Automation**

- Добавлен запуск **Vanessa Automation** прямо из панели **Менеджера тестов** (бывш. Phase Switcher) ([#13](https://github.com/kakoytochelik/KOTfor1C/issues/13)):
  - Два режима запуска: обычный автоматический прогон выбранных тестов и запуск для произвольной работы.
  - Отображение статуса сценария: выполняется, успешно, с ошибкой, устаревший результат (например, если был изменен какой-либо связанный вложенный сценарий).
  - Возможность быстро открыть файл лога по неудачному завершению теста.
  - Live-просмотр лога во время выполнения сценария (с настраиваемым интервалом обновления).
- Добавлена вкладка `Избранное`:
  - Быстрое открытие избранного сценария, или удаление из списка.
  - Drag-and-drop избранных сценариев в редактор: вставка вызова вложенного сценария с параметрами.
  - Тесты можно добавлять и удалять в `Избранное` через контекстное меню редактора.
  - Автодобавление новых сценариев в `Избранное` (переключается в настройках).
  - Список избранных поддерживает сортировку по названию и по коду сценария.
- Доработан UI панелей в Activity bar (Test Manager / сборка):
  - Добавлен компактный поиск по главным сценариям.
  - Обновлена компоновка нижней панели сборки (`Build tests`, `Build FL`, `Accounting mode`) и поведение выпадающих меню.
- Добавлена подсветка главных сценариев, на которые влияет текущий открытый файл.
- Добавлена возможность переименования групп и сценариев через контекстное меню.

### Сборка тестов и Менеджер Параметров

- Доработан процесс сборки сценариев:
  - Добавлена возможность отмены текущей сборки тестов.
  - Выбор чекбоксов в Менеджере тестов теперь автоматически формирует `Exceptscenario` / `Scenariofilter` для обработки сборки (без физического перемещения файлов).
  - После сборки: быстрый доступ к feature-файлам и каталогу результатов ([#9](https://github.com/kakoytochelik/KOTfor1C/issues/9)).
- Новый интерфейс Менеджера Параметров с вкладками:
  - параметры сборки СППР (было);
  - дополнительные параметры Vanessa Automation (новое);
  - глобальные переменные `GlobalVars` (новое).
  - Импорт/экспорт JSON для каждой вкладки.
  - Поиск по имени параметра на каждой вкладке.

### Редактор и качество сценариев

- Добавлена диагностика сценариев, подсветка ошибок и предупреждений ([#14](https://github.com/kakoytochelik/KOTfor1C/issues/14)):
  - неизвестные шаги и вызовы;
  - лишние и недостающие параметры;
  - проблемы с кавычками;
  - незакрытые `If/Do` блоки;
  - неполные служебные секции;
  - дубли кода сценария.
- Функция `Quick Fix` для ошибок:
  - Замена на ближайший похожий шаг или вызов с сохранением аргументов строки.
  - Блок `Maybe you meant` с предложениями похожих шагов в описании ошибки.
  - Автодобавление недостающих параметров.
- Улучшены hover-подсказки и IntelliSense:
  - по шагам: с фактическими аргументами из строки;
  - по вызовам: с описанием сценария и краткой сводкой (сколько файлов, параметров и внутренних вызовов других сценариев) ([#12](https://github.com/kakoytochelik/KOTfor1C/issues/12)).
- Улучшено автодополнение вызовов вложенных сценариев и подстановка значений параметров по умолчанию.
- Добавлено автодополнение переменных по символу `$`: предлагаются переменные, ранее сохраненные в сценарии, а также пользовательские `GlobalVars` из Менеджера параметров, с подстановкой в формате `$VariableName$`.
- Добавлено автовыравнивание Gherkin-таблиц и параметров вызовов сценариев при сохранении файла ([#7](https://github.com/kakoytochelik/KOTfor1C/issues/7), [#15](https://github.com/kakoytochelik/KOTfor1C/issues/15)).
- Автозаполнение блоков `ВложенныеСценарии` и `ПараметрыСценария` теперь происходит только при реальных изменениях.
- Добавлена проверка уникальности имени и кода при создании сценариев.
- Добавлена настройка расширения, определяющая язык для новых сценариев (`#language: ru/en`).
- Для редакторных функций язык теперь определяется в первую очередь по тегу `#language:` в текущем файле (с fallback на настройку расширения).
- Добавлена настройка расширения, переключающая видимость специфического для 1C:Drive функционала.

### Метаданные сценариев

- Добавлен и поддерживается блок `KOTМетаданные` для хранения служебных данных.
- Автомиграция legacy-тегов в новый формат при сохранении.
- Поддержка пользовательского описания сценария в `KOTМетаданные.Описание` ([#12](https://github.com/kakoytochelik/KOTfor1C/issues/12)).

## Исправления и доработки

- Улучшена стабильность автосохранения и операций перезаполнения секций ([#6](https://github.com/kakoytochelik/KOTfor1C/issues/6)).
- Улучшена производительность обновления кеша ([#11](https://github.com/kakoytochelik/KOTfor1C/issues/11)).
- Переключение панелей в Activity bar больше не снимает блокировку во время сборки сценариев ([#17](https://github.com/kakoytochelik/KOTfor1C/issues/17)).
- Доработаны локализация, контекстные меню и визуальная структура интерфейса.
- Размер `.vsix` значительно уменьшен.
- Обновлены `codicons`.
- Реорганизация настроек.


---
---
---


# 1.11.2
- **Новые возможности**:
    - **Менеджер параметров Сборки Сценариев:**
        - Новый интерфейс для управления параметрами `yaml_parameters.json` через удобную таблицу ключ-значение.
        - Параметры по умолчанию генерируются на основе настроек расширения (BuildPath, yamlSourceDirectory).
        - Безопасное хранение настроек в VS Code SecretStorage.
        - Поддержка загрузки/сохранения параметров из/в JSON файлы.
        - Список поддерживаемых параметров доступен [на ИТС](https://its.1c.ru/db/sppr2doc#content:124:hdoc:issogl1_11.8.3).
- **Исправления**:
    - **Исправлена недоступность кнопки обновления:** Кнопка "Обновить" теперь всегда доступна, даже когда не найдено ни одного теста для Переключателя фаз.
    - **Исправлены жестко заданные пути:** Заменена жестко заданная константа `SCAN_DIR_RELATIVE_PATH` на использование настройки `YamlSourceDirectory`.
    - Исправлены непереведенные сообщения и тултипы.
    - Исправлено добавление лишней строки в блок ВложенныеСценарии.
    - Табуляции теперь заменяются только в начале строки.
    - Сборка файла FirstLaunch теперь обрабатывает только нужные xml файлы.
    - Создание новых главных сценариев теперь учитывает настройку ModelBDid (указывается в Менеджер параметров Сборки Сценариев).
    - Автозамена табов и перезаполнение блоков в шапке сценариев, а также предложения автодополнения шагов, теперь работают только в YAML файлах, имеющих строку `ТипФайла: "Сценарий"` (это защита yaml файлов, не относящихся к тестам).
- **Удалено**:
    - **Настройка YAML Parameters Template:** Удалена в пользу нового Менеджера параметров Сборки Сценариев.
    - **Настройка Split Feature Files:** Удалена, так как задается через Менеджер параметров Сборки Сценариев.
    - **Настройка параметров СборкаТекстовСценариев:** Удалена, так как все параметры теперь управляются через Менеджер параметров Сборки Сценариев.

# 1.10.6
- Исправлено запоминание значений параметров, когда значение - пустая строка.

# 1.10.5
- **Новые возможности**:
    - **Автозаполнение при сохранении:**
        - Добавлена возможность автоматического заполнения секций ВложенныеСценарии и ПараметрыСценария при сохранении YAML файлов.
        - Новая логика "очистить и заполнить заново" обеспечивает правильный порядок элементов согласно тексту сценария.
        - Сохранение пользовательских значений параметров (поле `Значение: "Value"`) при автозаполнении.
        - Отдельные настройки для каждой функции: замена табов, заполнение вложенных сценариев, заполнение параметров.
        - Единый прогресс-бар и консолидированные уведомления о выполненных операциях.
        - Автоматическое сохранение файла после обработки для предотвращения отображения несохраненных изменений.
    - **Оптимизация производительности:**
        - **Инициализация кеша при запуске:** Сканирование рабочей области и построение кеша сценариев происходит сразу при активации расширения, а не при первом открытии панели.
        - **Кеширование UID сценариев:** Добавлено извлечение и кеширование UID из блоков ДанныеСценария для быстрого доступа.
        - **Оптимизированное заполнение вложенных сценариев:** Использование кеша вместо поиска по файловой системе ускоряет операцию в 25-50 раз.
        - **Оптимизированное открытие сценариев:** Мгновенное открытие сценариев через кеш вместо медленного поиска по файлам (ускорение в 50-100 раз).
- **Исправления**:
    - **Унифицированная логика:** Ручные команды и автосохранение используют одинаковую логику "очистить и заполнить".
    - **Улучшенная обработка параметров:** Корректное определение параметров сценария (только символы `_`, `-`, буквы и цифры).

# 1.9.9
- **Новые возможности**:
    - **Настраиваемые параметры запуска 1С:**
        - Добавлена возможность настройки всех параметров запуска 1С:Предприятие через единую строку настроек.
        - Отдельная настройка для дополнительных параметров `/C` для обработки СборкаТекстовСценариев. Подробнее о параметрах [здесь](https://its.1c.ru/db/sppr2doc#content:124:hdoc).
    - **Настраиваемые пути проекта:**
        - Все ранее жестко заданные пути теперь можно настроить через параметры расширения.
        - Настройка пути к папке FirstLaunch с автоматическим скрытием кнопки, если папка не существует.
    - **Улучшенная обратная связь при сборке:**
        - Улучшенные уведомления о результатах сборки.
        - Улучшенное отображение Output лога.
        - Кнопка "Открыть файл ошибок" для быстрого доступа к JUnit XML файлу с подробностями.
        - Точное определение наличия ошибок через анализ содержимого JUnit XML файла.
- **Исправления и улучшения**:
    - **Оптимизированы файлы локализации:** Удалены неиспользуемые строки переводов.
    - **Исправлена нумерация настроек:** Все настройки теперь имеют последовательные номера порядка для корректного отображения.
    - **Удалена устаревшая функциональность:** Полностью убрана обработка DriveTrade.

# 1.9.1
- **Новые возможности**:
    - **Мультиязычность:**
        - Полная локализация интерфейса расширения на русский и английский языки.
        - Настройка `Language override` для выбора языка расширения независимо от языка VS Code.
        - Мультиязычные шаги Gherkin с поддержкой 4-колоночной структуры в `steps.htm` (русский шаг, русское описание, английский шаг, английское описание).
        - Умное отображение: при вводе русского шага показывается русское описание и оба варианта шага, при вводе английского - английское описание и так же оба варианта.
    - **Автоматическая конвертация табов:**
        - При сохранении YAML файлов табуляции автоматически заменяются на пробелы.
        - Удалена ручная команда "Заменить табы на пробелы" из контекстного меню.
- **Исправления и доработки:**
    - Улучшен парсинг многострочных шагов из `steps.htm`.
    - Улучшена обработка ошибок с локализованными сообщениями.
    - Все операции поиска файлов, заполнения параметров и обновления шагов теперь показывают прогресс выполнения.

# 1.8.0
- **Новые возможности**:
    - **Автоматическое создание архива FirstLaunch:**
        - В палитре команд и в панели `Сборка` добавлена кнопка создания архива FirstLaunch `Собрать FL`.
        - Автоматически устанавливается версия конфигурации из текущей ветки во всех местах, где это требуется.
        - Возможность сохранить итоговый архив в пользовательскую директорию и открыть эту директорию.
- **Исправления и доработки:**
    - Панель `Сборка тестов` переименована в просто `Сборка`, так как теперь собираются не только тесты, но и архив FirstLaunch.
    - Список `Accounting` переименован в `Accounting mode`.
    - Убран переключатель DriveTrade, так как это легаси механика.
    - Параметр `Split Feature Files` теперь по умолчанию выключен.

# 1.7.1
- **Исправления и доработки:**
    - **Реорганизация настроек:**
        - Более точное расположение настроек по категориям.
        - Убраны неиспользуемые настройки (`DbUser`, `DbPassword`).
        - Вместо выпадающего списка `Split Feature Files` теперь является чекбоксом. Значение по умолчанию `True`. Добавлено более точное описание настройки.
    - **Проверка заполненности параметров:**
        - При попытке запустить сборку тестов без установленных в настройках путей будет понятная ошибка и предложение заполнить настройки.
        - При попытке открыть файл MXL без установленных в настройках путей будет понятная ошибка и предложение заполнить настройки.

# 1.7.0
- **Новые возможности**:
    - **Работа с файлами из редактора:**
        - **Открыть MXL файл в редакторе:** Добавлена команда в контекстное меню для поиска и открытия `.mxl` файла по выделенному имени в программе "1С:Предприятие — работа с файлами" (требуется установить отдельно).
        - **Показать файл в проводнике VS Code:** Новая команда для поиска файла по выделенному имени и его отображения в боковой панели VS Code.
        - **Открыть в системном проводнике:** Новая команда для открытия расположения найденного файла в Windows Explorer или Finder.
    - **Улучшения процесса сборки:**
        - **Прогресс-бар:** Во время сборки тестов теперь отображается уведомление с прогресс-баром.
        - **Уведомления об ошибках:** В случае неудачной сборки появляется уведомление с кнопкой для быстрого перехода к файлу лога.
        - **Опциональный Output:** Добавлена настройка для включения/отключения автоматического открытия панели Output при запуске сборки.
        - **Открытие результатов сборки**: После успешной сборки тестов можно открыть директорию с собранными `.feature` файлами.
    - **Создание сценариев:**
        - При создании главного или вложенного сценария теперь автоматически создается пустая папка files для сопутствующих файлов (унификация).

# 1.6.2
- **Новые возможности**:
    - Так как секции `ВложенныеСценарии` и `ПараметрыСценария` могут содержать множество блоков, для повышения удобства навигации и читабельности добавлена функция автоматического сворачивания этих секций при открытии файла теста. Переключается в настройках.

# 1.6.1
- **Исправления и доработки:**
    - Добавлена автонумерация автозаполняемых блоков в секциях `ВложенныеСценарии` и `ПараметрыСценария`.
    - Улучшена логика отступов и переносов строк для автозаполняемых блоков в секциях `ВложенныеСценарии` и `ПараметрыСценария`.
    - Исправлен и ускорен парсинг сценариев с спецсимволами для автозаполнения блоков в секциях `ВложенныеСценарии` и `ПараметрыСценария`.

## 1.6.0
- **Автозаполнение секции "ВложенныеСценарии":**
    - По команде контектного меню `1C:Drive - Заполнить секцию ВложенныеСценарии` секция автоматически заполняется недостающими блоками вызываемых сценариев.
- **Автозаполнение секции "ПараметрыСценария":**
    - По команде контектного меню `1C:Drive - Заполнить секцию ПараметрыСценария` секция автоматически заполняется недостающими блоками используемых в сценарии параметров.
- **Замена табов на пробелы:**
    - По команде контектного меню `1C:Drive - Заменить табы на пробелы` все отступы табуляциями заменяются на 4 пробела.
- **Убраны старые команды из контекстного меню:** (_они все еще доступны из палитры_)
    - `1C:Drive - Вставить блок ВложенныеСценарии`
    - `1C:Drive - Вставить блок ПараметрыСценария`

## 1.5.2
- **Улучшенная вставка блока "ВложенныеСценарии":**
    - Автозаполнение из выделения: Если при вызове команды выделена строка, соответствующая вызову сценария, расширение теперь попытается найти файл этого сценария.
    - В случае успеха, поля `UIDВложенныйСценарий` и `ИмяСценария` во вставляемом блоке будут автоматически заполнены значениями `UID` и `Имя` из найденного файла сценария.
    - Если файл сценария не найден, или из него не удалось извлечь UID/Имя, блок будет вставлен с пустыми значениями, как и раньше.
- **Секции контекстного меню**:
    - Пункты контекстного меню разделены на 3 категории:
        - Навигация
        - Создание
        - Редактирование

## 1.5.0
- **Автодополнение для вызовов вложенных сценариев:**
    - При вводе текста в блоке `ТекстСценария:` предлагаются варианты автодополнения не только для стандартных шагов Gherkin, **но и для вызовов всех найденных сценариев**.
    - Если выбранный для вставки сценарий содержит параметры, он вставляется как многострочный сниппет, включающий имя сценария и строки для каждого параметра с плейсхолдерами для их значений. 
    - Список сценариев и их параметров для автодополнения обновляется при нажатии кнопки "Обновить" на панели "KOT for 1C" (вместе с обновлением данных для Переключателя фаз).

- **Внешняя загрузка определений шагов Gherkin:**
    - Добавлена возможность загружать файл `steps.htm` (используемый для автодополнения и подсказок) с внешнего URL-адреса. Это позволяет обновлять определения шагов без необходимости обновления всего расширения.
    - В настройки расширения пользователь может указать URL для файла `steps.htm` (по умолчанию установлена ссылка на файл в репозитории). Если оставить пустым, будет использоваться только локальная копия из расширения.
    - Реализован механизм кеширования: загруженный файл сохраняется локально и используется в течение 24 часов или до следующего изменения URL.
    - Добавлена новая команда в палитру команд: `1C:Drive - Обновить библиотеку шагов`. Эта команда принудительно загружает `steps.htm` с указанного URL и обновляет кеш.
    - В случае недоступности внешнего ресурса или ошибки загрузки, расширение будет использовать данные из кеша (если он валиден) или, в крайнем случае, локальную копию `steps.htm`, включенную в состав расширения, для обеспечения непрерывной работы.

- **Кнопки создания сценариев:**
    - В панель Переключателя фаз добавлены кнопки создания Главных или Вложенных сценариев.

- **Исправлено:**
    - При создании нового Главного сценария, список тестов в Переключателе фаз теперь автоматически обновляется.



## 1.4.1
- Добавлена кнопка Свернуть/Развернуть все фазы
- Добавлена индикация непримененных изменений внутри фазы
- Обновление стилей кнопок 

## 1.4.0

- **Интеграция сборки тестов в TypeScript**:
    - Полностью перенесена логика скрипта `BuildYAML.bat` в код плагина (`phaseSwitcher.ts`).
    - Процесс сборки тестов теперь управляется непосредственно из расширения, используя API VS Code и Node.js для файловых операций и запуска процессов 1С.
    - [BETA] Сборка тестов теперь запускается на macOS.
- **Улучшения интерфейса "Переключатель фаз"**:
    - Заменен выпадающий список фаз на древовидное представление (Tree-View) с раскрывающимися группами.
    - В заголовки групп фаз добавлен счетчик включенных тестов.
    - Добавлены индивидуальные кнопки-переключатели в заголовок каждой фазы для переключения тестов внутри конкретной фазы. _(Удалена общая кнопка "Переключить фазу".)_
- **Исправления**:
    - [Кнопка Обновить активна во время сборки тестов](https://github.com/kakoytochelik/KOTfor1C/issues/2)
    - [Не запускается сборка тестов, если путь до пустой базы содержит пробелы](https://github.com/kakoytochelik/KOTfor1C/issues/1)

## 1.3.3

- Интегрирована функциональность сборки тестов в панель расширения с заменой переменных в тестах
- Добавлены настройки расширения
- Добавлены иконки кнопок
- Исправлены стили и отображение некоторых элементов интерфейса

## 1.2.0

- Реализовано автодополнение шагов Gherkin на основе библиотеки шагов Vanessa Automation.
- Добавлены всплывающие подсказки для шагов Gherkin, отображающие описание шага из библиотеки шагов Vanessa Automation при наведении мыши на строку шага в YAML файлах.

## 1.1.1

- Добавлена возможность переходить к родительским сценариям из Переключателя фаз
- Вставка блоков ВложенныеСценарии и ПараметрыСценария теперь происходит автоматически в соответствующие секции, а не в позицию курсора
- Улучшено отображение длинных названий сценариев в Переключателе фаз

## 1.0.0

- Первый релиз
